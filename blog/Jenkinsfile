node{
    stage('Clone repository'){
        checkout scm
        sh 'echo Repository cloned'
    }
    stage('Building app.'){
        app = docker.build("jakubnajman/blog","-f blog/Dockerfile .")
        sh 'echo App builded.'
    }
    stage('Test image'){
        app.inside {
            sh 'echo Test passed.'
        }
    }
    stage('Deploying on Kubernetes'){
        sh 'minikube start'
        sh 'cd blog && kubectl apply -f kube/'
        sh 'echo Deployments and services aplied.'
    }
    stage('Starting services'){
        sh 'minikube service postgreqsl-service'
        sh 'minikube service blog-service'
    }
}